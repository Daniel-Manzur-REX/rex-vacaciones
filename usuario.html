<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Usuario - REX Vacaciones</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(to right, #1a4d2e, #4caf50);
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header img {
      height: 50px;
    }
    .cerrar-sesion {
      display: flex;
      align-items: center;
    }
    .cerrar-sesion button {
      background-color: #b00020;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
    }
    main {
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
    }
    h1, h2 {
      color: #1a4d2e;
    }
    .info, .solicitud, .historial, .cambio-pass {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    label, input, button {
      display: block;
      width: 100%;
      margin-bottom: 1rem;
      padding: 0.75rem;
      font-size: 1rem;
      box-sizing: border-box;
    }
    input[type="date"] {
      max-width: 250px;
    }
    button {
      background-color: #1a4d2e;
      color: white;
      border: none;
      cursor: pointer;
    }
    .error {
      color: red;
      margin-top: -0.5rem;
      margin-bottom: 1rem;
    }
    .success {
      color: green;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.75rem;
      text-align: left;
    }
    th {
      background-color: #e8f5e9;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const sesion = JSON.parse(localStorage.getItem('usuarioActivo'));
    if (!sesion || !sesion.usuario) {
      window.location.href = 'login.html';
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCKaMDGTSblZJ6ZdtBy4F8lBH8ZQdWSiw8",
      authDomain: "rex-vacaciones.firebaseapp.com",
      databaseURL: "https://rex-vacaciones-default-rtdb.firebaseio.com",
      projectId: "rex-vacaciones",
      storageBucket: "rex-vacaciones.appspot.com",
      messagingSenderId: "919755172448",
      appId: "1:919755172448:web:3ed268536ae199f7a67105",
      measurementId: "G-Q8CX1R0RXY"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function cerrarSesion() {
      localStorage.removeItem('usuarioActivo');
      window.location.href = 'login.html';
    }

    function cargarDatosUsuario() {
      document.getElementById('nombreUsuario').textContent = sesion.nombre;
      document.getElementById('diasTotales').textContent = sesion.dias;
      document.getElementById('diasUsados').textContent = sesion.usados;
      document.getElementById('diasRestantes').textContent = sesion.dias - sesion.usados;

      db.ref('solicitudes').orderByChild('usuario').equalTo(sesion.usuario).once('value').then(snapshot => {
        const tbody = document.getElementById('tabla-solicitudes');
        tbody.innerHTML = '';
        snapshot.forEach(child => {
          const solicitud = child.val();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${solicitud.inicio}</td>
            <td>${solicitud.fin}</td>
            <td>${solicitud.estado}</td>
            <td>${solicitud.justificacion || ''}</td>
            <td><button onclick="cancelarSolicitud('${child.key}')">Eliminar</button></td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    function cancelarSolicitud(id) {
      if (confirm('¿Seguro que deseas eliminar esta solicitud?')) {
        db.ref('solicitudes/' + id).remove().then(() => location.reload());
      }
    }

    function enviarSolicitud() {
      const inicio = document.getElementById('inicio').value;
      const fin = document.getElementById('fin').value;
      const justificacion = document.getElementById('justificacion').value.trim();
      const hoy = new Date();
      const fechaInicio = new Date(inicio);
      const fechaFin = new Date(fin);
      const diasAnticipacion = 15;

      if (!inicio || !fin || fechaFin < fechaInicio) {
        alert('Fechas inválidas');
        return;
      }

      if ((fechaInicio - hoy) / (1000 * 60 * 60 * 24) < diasAnticipacion) {
        alert('Debes solicitar tus vacaciones con al menos 15 días de anticipación.');
        return;
      }

      const diasSolicitados = Math.ceil((fechaFin - fechaInicio) / (1000 * 60 * 60 * 24)) + 1;

      db.ref(`solicitudes`).once('value').then(snapshot => {
        const solicitudes = snapshot.val();
        let diasPendientes = 0;
        if (solicitudes) {
          Object.values(solicitudes).forEach(s => {
            if (s.usuario === sesion.usuario && s.estado === 'Aprobado') {
              const f1 = new Date(s.inicio);
              const f2 = new Date(s.fin);
              diasPendientes += Math.ceil((f2 - f1) / (1000 * 60 * 60 * 24)) + 1;
            }
          });
        }
        const restantes = sesion.dias - diasPendientes;
        if (diasSolicitados > restantes) {
          alert('No tienes suficientes días disponibles.');
          return;
        }

        const nuevaSolicitud = {
          usuario: sesion.usuario,
          inicio,
          fin,
          estado: 'Aprobado',
          justificacion
        };

        db.ref('solicitudes').push(nuevaSolicitud).then(() => {
          db.ref(`usuarios/${sesion.usuario.replace(/[.#$\[\]]/g, '_')}/usados`).set(diasPendientes + diasSolicitados);
          alert('Solicitud registrada correctamente.');
          location.reload();
        });
      });
    }

    function cambiarContrasena() {
      const nueva = document.getElementById('nueva-pass').value;
      if (nueva.length < 6) {
        alert('La contraseña debe tener al menos 6 caracteres.');
        return;
      }
      const key = sesion.usuario.replace(/[.#$\[\]]/g, '_');
      db.ref('usuarios/' + key + '/contrasena').set(nueva).then(() => {
        alert('Contraseña actualizada.');
        document.getElementById('nueva-pass').value = '';
      });
    }

    window.onload = cargarDatosUsuario;
  </script>
</head>
<body>
  <header>
    <img src="assets/creamos-futuro.png" alt="Logo RE">
    <div class="cerrar-sesion">
      <button onclick="cerrarSesion()">Cerrar sesión</button>
    </div>
  </header>
  <main>
    <section class="info">
      <h2>Bienvenido, <span id="nombreUsuario"></span></h2>
      <p><strong>Días totales:</strong> <span id="diasTotales"></span></p>
      <p><strong>Días usados:</strong> <span id="diasUsados"></span></p>
      <p><strong>Días restantes:</strong> <span id="diasRestantes"></span></p>
    </section>

    <section class="solicitud">
      <h2>Solicitar vacaciones</h2>
      <label for="inicio">Fecha de inicio</label>
      <input type="date" id="inicio">
      <label for="fin">Fecha de fin</label>
      <input type="date" id="fin">
      <label for="justificacion">Justificación</label>
      <input type="text" id="justificacion">
      <button onclick="enviarSolicitud()">Enviar solicitud</button>
    </section>

    <section class="historial">
      <h2>Historial de solicitudes</h2>
      <table>
        <thead>
          <tr>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Estado</th>
            <th>Justificación</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tabla-solicitudes"></tbody>
      </table>
    </section>

    <section class="cambio-pass">
      <h2>Cambiar contraseña</h2>
      <label for="nueva-pass">Nueva contraseña</label>
      <input type="password" id="nueva-pass">
      <button onclick="cambiarContrasena()">Actualizar contraseña</button>
    </section>
  </main>
</body>
</html>
